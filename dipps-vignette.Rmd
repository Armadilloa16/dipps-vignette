---
title: "DIPPS"
author: "Lyron Winderbaum"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{DIPPS}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

This vignette is seperated into four main sections:

* IO: Mainly use of the `combine_peaklists` function.
* Peakgrouping: Covers three approaches to constructing variables for such MSI 
  data:
    * Extracting known masses using given mass tolerances.
    * Tolerance clustering using equivalence classes.
    * Density Based Clustering using DBSCAN*.
* DIPPS: How to calculate DIPPS statistics.
* Plotting: How to produce various plots.

Included in this package is a full example dataset, named "A1" -- corresponding 
to the dataset A1 in: Feature extraction for proteomics imaging mass
spectrometry data. The Annals of Applied Statistics. 2015;9(4):1973-1996. doi: 
10.1214/15-AOAS870. In this vignette, this example dataset will be used to
demonstrate the above points.

## Housekeeping

First some housekeeping though. Loading the packages I will use:
```{r load_libraries}
library(dipps)
library(utils)
``` 

## IO 

### Combining peaklists

Here I use `system.file` to generate a valid path to the data folder for two 
reasons. A valid path to the data folder can be provided in other ways, 
including hardcoding it, which in some circumstances would be perfectly fine.
Notice that all optional arguments to `combine_peaklists` are allowed to 
default here. This means the peaklist files themselves are in a subfolder of 
the "A1" folder called "peaklists", and it means that the output files will be 
named with `dataset_name`. 
```{r read_data, cache = TRUE, echo = c(1, 3, 6)}
d.name = "A1"
untar(file.path(d.name, paste(d.name, "tar.gz", sep = ".")), exdir = d.name)
n.empty = combine_peaklists(d.name)
unlink(file.path(d.name, "peaklists", 
                 list.files(file.path(d.name, "peaklists"))))
unlink(file.path(d.name, "annotations.xml"))
print(n.empty)
```

I recommend removing any unnecessary columns from the peaklist as this will 
reduce the side of data significantly in many cases and make iteration faster 
by reducing load time in future (Maybe I could add this as a feature? Not sure 
that that is warrented.

THIS IS WHERE I AM UP TO.


A subset of an experimental 
dataset is included in the `extdata` folder of this package, for the purposes of 
providing a worked example. In this case the folder name is "A1", which in this 
case corresponds to a patient and section id -- this dataset corresponds to 
data on section 1 of sample A. The overall experiment included runs that 
collected MSI data from multiple sections of sample A, and from other samples.
Only a subset of the peaklists are included for filesize and runtime 
considerations. These data would be read in with:


and on successful completion n.empty would contain an integer representing the 
number of spectra read in that were empty (no detected peaks). Note that I use 
`system.file` here to produce a filepath, but in general if the data was in the 
current working directory I could simply call `combine_peaklists("A1")`, or if 
the folder name had the standard ".d" extension I would call 
`combine_peaklists("A1.d")`. In both cases however it would generally be 
preferable to provide full filepaths, to avoid complications with current 
working directories being inconsistent.

### Reading Combined peaklist and speclist files.

TODO: Maybe I should remove the `load_*` functions and just provide an example 
of how to read these files using `utils`. Seems much simpler. Also maybe convert 
to writing csv files instead of tabs.

## Peak Grouping

Generally, from a statistical perspective the spectra of an MSI experiment will 
be the observations of your experiement, and the variables will be some 
partitioning or grouping based on m/z values. However precisely what the 
variables should be is oftennot immediately obvious. There are a number of 
approaches made available in the `dipps` package, which are covered here.

### Extract Known Masses

### Tolerance Clustering

### Density Based Clustering

## DIPPS

## Plotting

```{r}
unlink(c("A1_peaklist.txt", "A1_speclist.txt"))
``` 


